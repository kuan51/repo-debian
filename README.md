# repo-debian

Docker solution to host debian packages for the XenME and XenFi platforms.

## Dependencies

- gnupg2
- Install Gnupg for Windows if using WSL

## Github Action Notes

The github action builds and pushes the Docker image to the github container registry. However, for security, the pgp keys are not committed to the repository. They are stored as secrets for github actions. Due to being multi line, they are also base64 encoded. In order to access them in the github action workflow, you must do something like the following which will print the original file to stdout.

```bash
echo "${{ secrets.PGP_PRIVATE_KEY }}" | base64 -d
```

## Installation

### Using the Docker Image

1. Create the file called `~/.gh_token` and save your github access token to it.

2. Login to github container registry using your token

    ```bash
    docker login -u gh_username --password-stdin ghcr.io < ~/.gh_token
    ```

3. Pull the latest version:

    ```bash
    docker pull ghcr.io/kuan51/repo-debian:latest
    ```

4. Then run:

    ```bash
    docker run --name deb-repo -p 80:80 -p 443:443 -d ghcr.io/kuan51/repo-debian:latest
    ```

5. Import the PGP public key on your client if you dont already have it in your keyring. The user is `repo` and the password you should use can be found in the container onces its running at this location: `/opt/repo/keys/htpasswd`.

    ```bash
    curl repo:password_here@deb.domain.com/repo/repo.gpg | gpg --import
    ```

6. Configure your linux client's apt repositories with the repo one:

    ```bash
    gpg --export repo | sudo tee -a /etc/apt/trusted.gpg.d/repo.gpg > /dev/null
    echo "deb https://repo:password_here@deb.domain.com/repo stable main" > /etc/apt/sources.list.d/repo.list
    apt update && apt search xenfi
    ```

### Building the Docker Image Yourself

All commands are in bash. It is recommended to use WSL or a debian/ubuntu VM.

1. Copy and save the public and private keys for the debian repo.

    ```bash
    cp repo.key src/private/repo.key
    cp repo.pub src/private/repo.gpg
    gpg --import src/private/repo.key
    ```

    *OR*

    Create the pgp key for your repository. You dont want to generate this from within the docker image as it would be overwritten each time you build a new version.

    ```bash
    gpg2 --no-tty --batch --gen-key src/pgp_key.batch
    gpg2 --armor --export repo > src/private/repo.gpg
    gpg2 --armor --export-secret-keys repo > src/private/repo.key
    ```

2. Make sure to add the keys and the private/ folder to your .gitignore file if not already done. Also dont include unneccessary files for docker builds.

    ```bash
    echo -e "\nprivate/\nrepo.gpg\nrepo.key" >> .gitignore
    echo "build/*" >> .dockerignore
    echo ".github/*" >> .dockerignore
    echo "README.md" >> .dockerignore
    ```

3. Build and run the dockerfile. This must be run from the repo root.

    ```bash
    docker build -t repo-repo .
    docker run --name repo-deb-repo -p 80:80 -p 443:443 -d repo-repo
    ```

4. Once the container is running, you can get the password that was autogenerated from the file `/opt/repo/keys/htpasswd`.

5. On a debian/ubuntu client, set up the new repository. This guide assumes the repository server and client are on the same network already, or the server is publicly available. Update the `APT_REPO` variable with the IP/domain name and port (*if applicable*) for the repository server.

    Easiest option is to test with a docker container on the same network

    ```bash
    docker run -it --rm ubuntu:latest
    ```

    Then from the console session:

    ```bash
    APT_REPO='172.17.0.2:80'
    REPO_USER='repo'
    REPO_PASSWD='password_here'
    apt update && apt install -y curl gnupg2 && curl $APT_REPO/repo/repo.gpg | gpg --dearmor > /etc/apt/trusted.gpg.d/repo.gpg
    echo "deb https://$REPO_USER:$REPO_PASSWD@$APT_REPO/repo stable main" > /etc/apt/sources.list.d/repo.list
    apt update && apt search xenfi
    ```
